<!DOCTYPE html>
<html>
<head>
    <title>Cockpitdecks - {{ deck.name }} </title>
<style>
body {
    font-family: sans-serif;
}
#deck {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
}
#deckname {
    text-align: center;
}
</style>
</head>
<!-- Structure as received:
{
  "address": "127.0.0.1",
  "deck-type-desc": {
    "__filename__": "/Users/pierre/Developer/fs/cockpitdecks/bin/../cockpitdecks/decks/resources/development deck.yaml",
    "buttons": [
      {
        "_intname": "NO_NAME_0",
        "action": "push",
        "feedback": "image",
        "image": [
          128,
          128
        ],
        "layout": [
          2,
          1
        ],
        "name": 0
      }
    ],
    "driver": "virtualdeck",
    "type": "Virtual Deck for Development"
  },
  "decor": {
    "background": "devdeck.png",
    "hspacing": 8,
    "vspacing": 8
  },
  "disabled": false,
  "layout": "virtualdevdeck",
  "name": "Virtual deck for development",
  "port": 7775,
  "serial": "127.0.0.1:7775",
  "type": "Virtual Deck for Development"
}
-->
<body>
    <h2 id="deckname">{{ deck.name }}</h2>
<!--
    <input type="text" id="message" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
-->
    <div>
        <canvas id="deck" width="800" height="600" style="border:1px solid grey;">
            Sorry, your browser does not support canvas.
        </canvas>
    </div>
    <!-- h4>Debugging Deck Data</h4>
    <div><pre>{{ deck|tojson(indent=2) }}</pre></div>
    <div>{{ deck["deck-type-desc"]["buttons"][0]["image"][0] }}</div -->
<script type="text/javascript">

// Canvas setup
const canvas = document.getElementById("deck");
const ctx = canvas.getContext("2d");
const KEY_HSPACING = 8
const KEY_VSPACING = 8
const icon_height = {{ deck["deck-type-desc"]["buttons"][0]["image"][0] }}
const icon_width = {{ deck["deck-type-desc"]["buttons"][0]["image"][1] }}
const keys_horiz = {{ deck["deck-type-desc"]["buttons"][0]["layout"][0] }}
const keys_vert = {{ deck["deck-type-desc"]["buttons"][0]["layout"][1] }}


// Canvas functions
function resize_canvas(ctx, image, layout, spacing) {
    ctx.canvas.width = image[0] * layout[0] + spacing[0] * (layout[0] - 1)
    ctx.canvas.height = image[1] * layout[1] + spacing[1] * (layout[1] - 1)
    console.log("canvas resize", image[0], layout[0], spacing[0], image[1], layout[1], spacing[1], ctx.canvas.width, ctx.canvas.height)
}

function relMouseCoords(event){
    var totalOffsetX = 0;
    var totalOffsetY = 0;
    var canvasX = 0;
    var canvasY = 0;
    var currentElement = this;

    do{
        totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
        totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
    }
    while(currentElement = currentElement.offsetParent)

    canvasX = event.pageX - totalOffsetX;
    canvasY = event.pageY - totalOffsetY;

    return {x:canvasX, y:canvasY}
}
HTMLCanvasElement.prototype.relMouseCoords = relMouseCoords;


// Internal kitchen functions
function get_xy(key) {

    var x = (icon_width + KEY_HSPACING) * (key % keys_horiz)
    var y = (icon_height + KEY_HSPACING) * Math.floor(key/keys_horiz)
    // console.log("get_xy", key, x, y);
    return [x, y]
}

function get_key(x, y) {
    w2 = icon_width + KEY_VSPACING
    h2 = icon_height + KEY_HSPACING
    h = Math.floor(x / w2)
    v = Math.floor(y / h2)
    key = v * keys_horiz + h
    //console.log("get_key", key);
    return key
}

resize_canvas(ctx, [icon_width, icon_height], [keys_horiz, keys_vert], [KEY_HSPACING, KEY_VSPACING])

canvas.addEventListener("mousedown", function(e) {
    coords = canvas.relMouseCoords(event);
    sendCoordinates("{{deck.name}}", coords, 1)
})

canvas.addEventListener("mouseup", function(e) {
    coords = canvas.relMouseCoords(event);
    canvasX = coords.x;
    canvasY = coords.y;
    sendCoordinates("{{deck.name}}", coords, 0)
})

// WebSocket initialisation and setup
var ws = new WebSocket("ws://127.0.0.1:7777/cockpit");

ws.onopen = (event) => {
    console.log("opened");
    // sends its name on new connection to help identify
    sendCode(1, "{{deck.name}}")
};

ws.onmessage = (event) => {
    //console.log("data received");
    var data = JSON.parse(event.data)
    console.log("code received:", data.code);
    if (data.code == 0) {
        //console.log("loading image (key)..", data.key)
        coords = get_xy(data.key)
        var image = new Image();
        image.onload = function() {
            ctx.drawImage(image, coords[0], coords[1]);
            //console.log("drawing at", coords[0], coords[1])
        };
        image.src = "data:image/jpeg;base64,"+data.image;
        //console.log("..done")
    }
};

// Send functions
function sendMessage() {
    var message = document.getElementById("message").value;
    ws.send(message);
    console.log("send message", message + " sent");
}

function sendCode(code, deck) {
    c = {"code": code, "deck": deck}
    var message = JSON.stringify(c)
    ws.send(message);
    console.log("send code", message + " sent");
}

function sendCoordinates(deck, c, z) {
    //console.log(deck, c.x, c.y, z)
    key = get_key(c.x, c.y)
    payload = {"code": 0, "deck": deck, "key": key, "x": c.x, "y": c.y, "z": z}
    var message = JSON.stringify(payload)
    ws.send(message);
    //console.log(message + " sent");
}

</script>
</body>
</html>
